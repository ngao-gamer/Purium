-- =========================================================================
-- KHAI B√ÅO TH∆Ø VI·ªÜN & SERVICE CHUNG 
-- S·ª¨ D·ª§NG FLUENT PLUS (ƒê√É S·ª¨A L·ªñI INFINITE DODGE V√Ä UNIFIED ESP)
-- =========================================================================

-- 1. Load Fluent UI Library
local Fluent = loadstring(game:HttpGet("https://raw.githubusercontent.com/discoart/FluentPlus/refs/heads/main/release.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- 2. Khai b√°o Services
local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")
local Debris = game:GetService("Debris")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local Stats = game:GetService("Stats")

-- 3. Bi·∫øn Local Player v√† Chu·ªôt
local LocalPlayer = Players.LocalPlayer
local IYMouse = LocalPlayer:GetMouse()
local CurrentCamera = Workspace.CurrentCamera
local defaultWalkSpeed = 16
local defaultJumpPower = 50

-- =========================================================================
-- GLOBAL FLAGS & CONFIGS 
-- =========================================================================
local staminaLoopActive = false
local gasLoopActive = false
local combatStaminaLoopActive = false
local clashLoopActive = false
local BarrierDestroyerEnabled = false
local noclipEnabled = false
local FLYING = false
local aimbotEnabled = false
local clickTeleportEnabled = false
local jumpUnlockerEnabled = false
local antiAFKActive = false
local cancelRecoilActive = false
local targetWalkSpeed = defaultWalkSpeed
local infDodgeConnection 

-- =========================================================================
-- LOGIC H√ÄM T√ÅCH R·ªúI (EXPLICIT & VERBOSE FUNCTIONS)
-- =========================================================================

--- H√ÄM: INFINITE RESOURCES ---
local function toggleInfStamina(Value)
    staminaLoopActive = Value
    if Value then
        task.spawn(function()
            while staminaLoopActive do
                pcall(function() 
                    local stats = LocalPlayer.Character and LocalPlayer.Character.Stats
                    if stats and stats.Stamina then stats.Stamina.Value = 100 end
                end)
                task.wait(0.5) 
            end
        end)
    end
end

local function toggleInfCombatStamina(Value)
    combatStaminaLoopActive = Value
    if Value then
        task.spawn(function()
            while combatStaminaLoopActive do
                pcall(function() 
                    local stats = LocalPlayer.Character and LocalPlayer.Character.Stats
                    if stats and stats.CombatStamina then stats.CombatStamina.Value = 100 end
                end)
                task.wait(0.5) 
            end
        end)
    end
end

local function toggleAutoWinClash(Value)
    clashLoopActive = Value
    if Value then
        task.spawn(function()
            while clashLoopActive do
                pcall(function() 
                    local stats = LocalPlayer.Character and LocalPlayer.Character.Stats
                    if stats and stats.ClashStrength then stats.ClashStrength.Value = 100 end
                end)
                task.wait(0.01) 
            end
        end)
    end
end

local function toggleInfGas(Value)
    gasLoopActive = Value
    if Value then
        task.spawn(function()
            while gasLoopActive do
                pcall(function() 
                    local items = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Items")
                    if items and items:FindFirstChild("XSaw") then
                        items.XSaw:SetAttribute("Gas", 100)
                    end
                end)
                task.wait(0.1) 
            end
        end)
    end
end

--- H√ÄM: INFINITE DODGE (ƒê√É FIX L·ªñI) ---
local function enableInfDodge()
    if infDodgeConnection and infDodgeConnection.Disconnect then infDodgeConnection:Disconnect() end
    
    local original_call_ref 
    
    local hooked_result = hookmetamethod(game, "__namecall", function(self, ...)
        if not original_call_ref then return end
        
        if not checkcaller() and getnamecallmethod() == "FireServer" then
            if self.Name == "CTS" then
                local args = {...}
                if args[1] == "DoneDodge" then args[1] = "Dodge" end
                return original_call_ref(self, unpack(args))
            end
        end
        return original_call_ref(self, ...)
    end)
    
    infDodgeConnection = hooked_result 
    original_call_ref = hooked_result 
end

--- H√ÄM: AIMBOT & RECOIL ---

local cancelRecoilConnection
local function toggleCancelRecoil(Value)
    cancelRecoilActive = Value
    if cancelRecoilConnection then cancelRecoilConnection:Disconnect() end

    if Value then
        cancelRecoilConnection = RunService.RenderStepped:Connect(function()
            pcall(function() 
                local character = LocalPlayer.Character
                if character then
                    local humanoid = character:FindFirstChildOfClass("Humanoid")
                    if humanoid then
                        humanoid.CameraOffset = Vector3.new(0, 0, 0)
                    end
                end
            end)
        end)
    else
        cancelRecoilConnection = nil
    end
end

local rightMouseDown = false
local aimbotConnection
local function getChainTarget()
    local aiFolder = Workspace:FindFirstChild("Misc") and Workspace.Misc:FindFirstChild("AI")
    if not aiFolder then return nil end
    for _, child in ipairs(aiFolder:GetChildren()) do
        if child:FindFirstChild("HumanoidRootPart") and child.Name:match("CHAIN") then
            return child 
        end
    end
    return nil
end

local function handleAimbotLoop()
    if aimbotConnection then return end
    aimbotConnection = RunService.RenderStepped:Connect(function()
        if aimbotEnabled and rightMouseDown then
            local aimTarget = getChainTarget()
            if aimTarget and aimTarget:FindFirstChild("HumanoidRootPart") then
                local targetHRP = aimTarget.HumanoidRootPart
                CurrentCamera.CFrame = CFrame.new(CurrentCamera.CFrame.Position, targetHRP.Position)
            end
        end
    end)
end

local function setupAimbotInput()
    UserInputService.InputBegan:Connect(function(input, processed)
        if processed then return end
        if input.UserInputType == Enum.UserInputType.MouseButton2 then rightMouseDown = true end
    end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton2 then rightMouseDown = false end
    end)
end

local function toggleAimbot(Value)
    aimbotEnabled = Value
    if Value then
        handleAimbotLoop()
        setupAimbotInput()
    end
end

--- H√ÄM: UTILITY KH√ÅC ---

local function toggleWorkbenchGui(Value)
    pcall(function()
        local Work = LocalPlayer:WaitForChild("PlayerGui"):WaitForChild("Ingame"):WaitForChild("Workbench")
        Work.Visible = Value
    end)
end

local function toggleDeconstructorGui(Value)
    pcall(function()
        local De = LocalPlayer:WaitForChild("PlayerGui"):WaitForChild("Ingame"):WaitForChild("Deconstructor")
        De.Visible = Value
    end)
end

local function toggleShopGui(Value)
    pcall(function()
        local Shop = LocalPlayer:WaitForChild("PlayerGui"):WaitForChild("Ingame"):FindFirstChild("Shop")
        if Shop then Shop.Visible = Value end
    end)
end

local function unlockBlueprint(itemName)
    pcall(function()
        local blueprints = LocalPlayer:WaitForChild("PlayerStats"):WaitForChild("Blueprints")
        if blueprints:GetAttribute(itemName) ~= nil then
            blueprints:SetAttribute(itemName, true)
            Fluent:Notify({ Title = "Th√†nh c√¥ng!", Content = "ƒê√£ m·ªü kh√≥a: " .. itemName, Duration = 3 })
        else
            Fluent:Notify({ Title = "L·ªói", Content = "Kh√¥ng t√¨m th·∫•y thu·ªôc t√≠nh: " .. itemName, Duration = 3 })
        end
    end)
end

local function ThirdPerson()
    pcall(function()
        LocalPlayer.CameraMode = Enum.CameraMode.Classic 
        LocalPlayer.CameraMaxZoomDistance = 1280 
        LocalPlayer.CameraMinZoomDistance = 0.5
    end)
end

local function removeMask()
    pcall(function()
        local sack = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Sack")
        if sack and sack:FindFirstChild("SurfaceAppearance") then
            sack.SurfaceAppearance.Parent:Destroy()
            Fluent:Notify({ Title = "Th√†nh c√¥ng!", Content = "ƒê√£ g·ª° m·∫∑t n·∫° tr√™n ƒë·∫ßu.", Duration = 3 })
        end
    end)
end

local function toggleBarrierDestroyer(Value)
    BarrierDestroyerEnabled = Value
    if Value then
        task.spawn(function()
            while BarrierDestroyerEnabled do
                pcall(function()
                    for _, child in ipairs(Workspace:GetDescendants()) do
                        if child:IsA("BasePart") and child.CanCollide and child.Transparency > 0.99 then
                            child.CanCollide = false
                        end
                    end
                end)
                task.wait(1)
            end
        end)
    end
end

local jumpConnection
local function toggleJumpUnlock(Value)
    jumpUnlockerEnabled = Value
    if jumpConnection then jumpConnection:Disconnect(); jumpConnection = nil end

    if Value then
        jumpConnection = RunService.Heartbeat:Connect(function() 
            local character = LocalPlayer.Character
            if character then 
                local humanoid = character:FindFirstChildOfClass("Humanoid")
                if humanoid and humanoid.JumpPower ~= defaultJumpPower then 
                    humanoid.JumpPower = defaultJumpPower 
                end
            end
        end)
    else
        pcall(function()
            LocalPlayer.Character:FindFirstChildOfClass("Humanoid").JumpPower = defaultJumpPower
        end)
    end
end

local antiAFKConnection
local function toggleAntiAFK(Value)
    antiAFKActive = Value
    if antiAFKConnection then antiAFKConnection:Disconnect(); antiAFKConnection = nil end

    if Value then
        antiAFKConnection = RunService.Heartbeat:Connect(function()
            if antiAFKActive then
                UserInputService:SimulateKeyPress(Enum.KeyCode.W)
                task.wait(0.5)
                UserInputService:SimulateKeyPress(Enum.KeyCode.S)
            end
        end)
    end
end

--- H√ÄM: MOVEMENT & TELEPORT ---

local noclipConnection
local function toggleNoclip(enabled)
    noclipEnabled = enabled
    local character = LocalPlayer.Character
    if not character then return end
    
    if noclipConnection then noclipConnection:Disconnect() end
    
    if enabled then
        noclipConnection = RunService.Heartbeat:Connect(function()
            if character then
                for _, part in ipairs(character:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = false
                        part.CanTouch = false
                    end
                end
            end
        end)
        if character:FindFirstChildOfClass("Humanoid") then
            character:FindFirstChildOfClass("Humanoid").WalkSpeed = 0
            character:FindFirstChildOfClass("Humanoid").JumpPower = 0
        end
    else
        if character:FindFirstChildOfClass("Humanoid") then
            character:FindFirstChildOfClass("Humanoid").WalkSpeed = targetWalkSpeed
            character:FindFirstChildOfClass("Humanoid").JumpPower = defaultJumpPower
        end
        if character then
            for _, part in ipairs(character:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = true
                    part.CanTouch = true
                end
            end
        end
    end
end

local flyKeyDown, flyKeyUp, flyRenderStep
local function NOFLY()
    FLYING = false
    pcall(function() 
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = LocalPlayer.Character.HumanoidRootPart
            if hrp:FindFirstChild("FlyVelocity") then hrp.FlyVelocity:Destroy() end
            if hrp:FindFirstChild("FlyTorque") then hrp.FlyTorque:Destroy() end
        end
        if flyKeyDown then flyKeyDown:Disconnect(); flyKeyDown = nil end
        if flyKeyUp then flyKeyUp:Disconnect(); flyKeyUp = nil end
        if flyRenderStep then flyRenderStep:Disconnect(); flyRenderStep = nil end
    end)
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid") then
        LocalPlayer.Character:FindFirstChildOfClass("Humanoid").PlatformStand = false
    end
end

local function sFLY(speed)
    NOFLY()
    FLYING = true
    local hrp = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    LocalPlayer.Character:FindFirstChildOfClass("Humanoid").PlatformStand = true
    
    local bv = Instance.new("BodyVelocity", hrp)
    bv.Name = "FlyVelocity"
    bv.MaxForce = Vector3.new(4e9, 4e9, 4e9)
    bv.Velocity = Vector3.zero
    
    local bg = Instance.new("BodyGyro", hrp)
    bg.Name = "FlyTorque"
    bg.P = 9e5
    bg.MaxTorque = Vector3.new(4e9, 4e9, 4e9)
    bg.CFrame = hrp.CFrame
    
    local CONTROL = {F = 0, B = 0, L = 0, R = 0, Q = 0, E = 0}
    local lCONTROL = {F = 0, B = 0, L = 0, R = 0, Q = 0, E = 0}
    
    flyRenderStep = RunService.RenderStepped:Connect(function()
        if not FLYING or not hrp or not hrp.Parent then NOFLY(); return end

        local SPEED = 0
        local flySpeed = speed or 100

        if CONTROL.L + CONTROL.R ~= 0 or CONTROL.F + CONTROL.B ~= 0 or CONTROL.Q + CONTROL.E ~= 0 then
            SPEED = 50
        elseif not (CONTROL.L + CONTROL.R ~= 0 or CONTROL.F + CONTROL.B ~= 0 or CONTROL.Q + CONTROL.E ~= 0) and SPEED ~= 0 then
            SPEED = 0
        end

        if (CONTROL.L + CONTROL.R) ~= 0 or (CONTROL.F + CONTROL.B) ~= 0 or (CONTROL.Q + CONTROL.E) ~= 0 then
            bv.velocity = ((CurrentCamera.CoordinateFrame.lookVector * (CONTROL.F + CONTROL.B)) + ((CurrentCamera.CoordinateFrame * CFrame.new(CONTROL.L + CONTROL.R, (CONTROL.F + CONTROL.B + CONTROL.Q + CONTROL.E) * 0.2, 0).p) - CurrentCamera.CoordinateFrame.p)) * SPEED * (flySpeed/50)
            lCONTROL = {F = CONTROL.F, B = CONTROL.B, L = CONTROL.L, R = CONTROL.R}
        elseif (CONTROL.L + CONTROL.R) == 0 and (CONTROL.F + CONTROL.B) == 0 and (CONTROL.Q + CONTROL.E) == 0 and SPEED ~= 0 then
            bv.velocity = ((CurrentCamera.CoordinateFrame.lookVector * (lCONTROL.F + lCONTROL.B)) + ((CurrentCamera.CoordinateFrame * CFrame.new(lCONTROL.L + lCONTROL.R, (lCONTROL.F + lCONTROL.B + CONTROL.Q + CONTROL.E) * 0.2, 0).p) - CurrentCamera.CoordinateFrame.p)) * SPEED * (flySpeed/50)
        else
            bv.velocity = Vector3.new(0, 0, 0)
        end
        bg.cframe = CurrentCamera.CoordinateFrame
    end)


    flyKeyDown = IYMouse.KeyDown:Connect(function(key)
        key = key:lower()
        if key == 'w' then CONTROL.F = 1 elseif key == 's' then CONTROL.B = -1
        elseif key == 'a' then CONTROL.L = -1 elseif key == 'd' then CONTROL.R = 1
        elseif key == 'e' then CONTROL.Q = 1 elseif key == 'q' then CONTROL.E = -1 
        elseif key == 'v' then NOFLY() return end
    end)
    
    flyKeyUp = IYMouse.KeyUp:Connect(function(key)
        key = key:lower()
        if key == 'w' then CONTROL.F = 0 elseif key == 's' then CONTROL.B = 0
        elseif key == 'a' then CONTROL.L = 0 elseif key == 'd' then CONTROL.R = 0
        elseif key == 'e' then CONTROL.Q = 0 elseif key == 'q' then CONTROL.E = 0 end
    end)
end

local clickTeleportConnection
local function handleTeleportInput(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        if clickTeleportEnabled and UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then
            local hit = IYMouse.Hit
            if hit and LocalPlayer.Character then
                LocalPlayer.Character:MoveTo(Vector3.new(hit.X, hit.Y, hit.Z))
            end
        end
    end
end

local function toggleClickTeleport(Value)
    clickTeleportEnabled = Value
    if clickTeleportConnection then clickTeleportConnection:Disconnect() end

    if Value then
        clickTeleportConnection = UserInputService.InputBegan:Connect(handleTeleportInput)
    else
        clickTeleportConnection = nil
    end
end

local function simpleServerHop()
    pcall(function()
        TeleportService:Teleport(game.PlaceId, LocalPlayer)
    end)
end

local function findAndTeleportToAirdrop()
    local allAirdrops = Workspace:FindFirstChild("GameStuff") and Workspace.GameStuff:FindFirstChild("GameSections") and Workspace.GameStuff.GameSections:FindFirstChild("AirDrops")
    if not allAirdrops or #allAirdrops:GetChildren() == 0 then
        Fluent:Notify({Title = "L·ªói", Content = "Hi·ªán kh√¥ng c√≥ Airdrop tr√™n b·∫£n ƒë·ªì.", Duration = 5}) 
        return
    end
    
    local targetAirdrop = allAirdrops:GetChildren()[1]
    local targetCFrame = targetAirdrop:GetPivot()
    
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        LocalPlayer.Character.HumanoidRootPart.CFrame = targetCFrame * CFrame.new(0, 10, 0)
        Fluent:Notify({Title = "Th√†nh c√¥ng", Content = "ƒê√£ d·ªãch chuy·ªÉn t·ªõi Airdrop.", Duration = 5})
    end
end

--- H√ÄM: VISUALS (ESP & GUI) ---

local screenEffectConnection
local function toggleHideScreenEffects(Value)
    local elementsToManage = { "CursedText", "Glitch", "StaticRegular", "StaticScare", "WhiteLines" }
    local playerGui = LocalPlayer:WaitForChild("PlayerGui", 5)
    
    if screenEffectConnection then screenEffectConnection:Disconnect(); screenEffectConnection = nil end

    if Value then
        screenEffectConnection = RunService.RenderStepped:Connect(function()
            for _, name in ipairs(elementsToManage) do
                local element = playerGui:FindFirstChild(name)
                if element and element.Visible then
                    element.Visible = false
                end
            end
        end)
    end
end

local infoGUIVisible = false
local infoGUIDisplay
local function createStyledInfoGUI()
    if infoGUIDisplay then return end
    infoGUIVisible = true
    
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "ChainInfoGUI"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = CoreGui
    
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "InfoFrame"
    mainFrame.Size = UDim2.new(0, 250, 0, 150)
    mainFrame.Position = UDim2.new(1, -260, 0.5, -75)
    mainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    mainFrame.BackgroundTransparency = 0.2
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = ScreenGui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = mainFrame
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Text = "Chain Boss Info"
    titleLabel.Size = UDim2.new(1, 0, 0, 30)
    titleLabel.Position = UDim2.new(0, 0, 0, 0)
    titleLabel.BackgroundColor3 = Color3.fromRGB(128, 0, 128)
    titleLabel.BackgroundTransparency = 0.6
    titleLabel.Font = Enum.Font.SourceSansBold
    titleLabel.TextColor3 = Color3.new(1, 1, 1)
    titleLabel.TextSize = 18
    titleLabel.Parent = mainFrame
    
    local contentFrame = Instance.new("Frame")
    contentFrame.Size = UDim2.new(1, 0, 1, -30)
    contentFrame.Position = UDim2.new(0, 0, 0, 30)
    contentFrame.BackgroundTransparency = 1
    contentFrame.Parent = mainFrame
    
    local layout = Instance.new("UIListLayout")
    layout.Padding = UDim.new(0, 5)
    layout.FillDirection = Enum.FillDirection.Vertical
    layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    layout.Parent = contentFrame
    
    local labels = {}
    local function createLabel(name)
        local label = Instance.new("TextLabel")
        label.Name = name
        label.Size = UDim2.new(1, -10, 0, 20)
        label.BackgroundTransparency = 1
        label.Font = Enum.Font.SourceSans
        label.TextColor3 = Color3.fromRGB(200, 200, 200)
        label.TextSize = 16
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = contentFrame
        return label
    end

    labels.RoundTime = createLabel("RoundTimeLabel")
    labels.Intermission = createLabel("IntermissionLabel")
    labels.Power = createLabel("PowerLabel")

    infoGUIDisplay = ScreenGui

    task.spawn(function()
        local valuesFolder = Workspace:WaitForChild("GameStuff"):WaitForChild("Values")
        while infoGUIVisible do
            pcall(function()
                local rt = valuesFolder:GetAttribute("RoundTime")
                local pwr = valuesFolder:GetAttribute("Power")
                
                labels.RoundTime.Text = "Round Time: " .. (rt and string.format("%.0f", rt) .. "s" or "N/A")
                labels.Intermission.Text = "Intermission: " .. (valuesFolder:GetAttribute("Intermission") and "Yes" or "No")
                labels.Power.Text = "Power: " .. (pwr and string.format("%.0f", pwr) .. "%" or "N/A")
            end)
            task.wait(1)
        end
    end)
end

local function destroyStyledInfoGUI()
    infoGUIVisible = false
    if infoGUIDisplay then infoGUIDisplay:Destroy(); infoGUIDisplay = nil end
end

local function toggleInfoGUI(Value)
    if Value then createStyledInfoGUI() else destroyStyledInfoGUI() end
end

-- =========================================================================
-- H·ªÜ TH·ªêNG ESP TH·ªêNG NH·∫§T (UNIFIED ESP)
-- =========================================================================
local espSettings = {
    Player = { Enabled = false, Color = Color3.fromRGB(255, 0, 0), Name = "Player" },
    Chain = { Enabled = false, Color = Color3.fromRGB(255, 21, 21), Name = "CHAIN BOSS" },
    Scrap = { Enabled = false, Color = Color3.fromRGB(255, 165, 0), Name = "Scrap" },
    Arctic = { Enabled = false, Color = Color3.fromRGB(0, 255, 255), Name = "Arctic" },
}
local espElements = {} -- L∆∞u tr·ªØ: { Instance = { Label, Highlight } }
local espGui
local espRenderStep

local function createEspGui()
    if espGui then return end
    
    espGui = Instance.new("ScreenGui")
    espGui.Name = "UniversalESPGUI"
    espGui.ResetOnSpawn = false
    espGui.Parent = CoreGui
end

local function getPartPosition(instance)
    if instance:IsA("Model") then
        return instance.PrimaryPart and instance.PrimaryPart.Position or instance:GetPivot().Position
    elseif instance:IsA("BasePart") then
        return instance.Position
    end
    return nil
end

local function getAllEspTargets()
    local targets = {}
    local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return targets end

    -- 1. Players
    if espSettings.Player.Enabled then
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                table.insert(targets, { 
                    Instance = player.Character, 
                    Type = "Player", 
                    Name = player.Name, 
                    Color = espSettings.Player.Color,
                    isModel = true,
                })
            end
        end
    end

    -- 2. Chain Boss
    if espSettings.Chain.Enabled then
        local chain = Workspace:FindFirstChild("Misc") and Workspace.Misc:FindFirstChild("AI") and Workspace.Misc.AI:FindFirstChild("CHAIN")
        if chain and chain:FindFirstChild("HumanoidRootPart") then
             table.insert(targets, { 
                Instance = chain, 
                Type = "Chain", 
                Name = espSettings.Chain.Name, 
                Color = espSettings.Chain.Color,
                isModel = true,
            })
        end
    end

    -- 3. Loot Items (Scrap & Arctic)
    if espSettings.Scrap.Enabled or espSettings.Arctic.Enabled then
        local itemsToFind = { 
            Scrap = { Type = "Scrap", Color = espSettings.Scrap.Color, Enabled = espSettings.Scrap.Enabled },
            Arctic = { Type = "Arctic", Color = espSettings.Arctic.Color, Enabled = espSettings.Arctic.Enabled }
        }
        for _, item in ipairs(Workspace:GetDescendants()) do
            local itemName = item.Name
            local itemConfig = itemsToFind[itemName]
            
            if itemConfig and itemConfig.Enabled and (item:IsA("Part") or item:IsA("Model")) then 
                table.insert(targets, {
                    Instance = item,
                    Type = itemConfig.Type,
                    Name = itemConfig.Name,
                    Color = itemConfig.Color,
                    isModel = item:IsA("Model")
                })
            end
        end
    end
    
    return targets
end

-- H√ÄM ƒê√É S·ª¨A: S·ª¨ D·ª§NG IF NOT POS THEN RETURN/ELSE
local function updateUniversalESP()
    local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    local hrpPosition = hrp.Position
    local currentTargets = {}
    local targetsData = getAllEspTargets()

    for _, data in ipairs(targetsData) do
        local item = data.Instance
        local itemKey = item 

        currentTargets[itemKey] = true

        local pos = getPartPosition(item)
        
        -- FIX T∆Ø∆†NG TH√çCH: Thay 'if not pos then continue end' b·∫±ng 'if pos then ... end'
        if pos then
            if not espElements[itemKey] then
                local label = Instance.new("TextLabel")
                label.Size = UDim2.new(0, 100, 0, 16) 
                label.BackgroundTransparency = 1
                label.Font = Enum.Font.SourceSansBold
                label.TextSize = 12 
                label.TextColor3 = data.Color
                label.TextStrokeTransparency = 0.5 
                label.Parent = espGui

                local highlight = Instance.new("Highlight")
                highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                highlight.FillColor = data.Color
                highlight.FillTransparency = 0.8
                highlight.OutlineColor = Color3.new(1, 1, 1)
                highlight.Enabled = false 
                pcall(function() highlight.Parent = item end) 

                espElements[itemKey] = { Label = label, Highlight = highlight, Target = item }
                
                item.Destroying:Connect(function()
                    if espElements[itemKey] then
                        pcall(function() espElements[itemKey].Label:Destroy() end)
                        pcall(function() espElements[itemKey].Highlight:Destroy() end)
                        espElements[itemKey] = nil
                    end
                end)
            end

            local elements = espElements[itemKey]
            local label = elements.Label
            local highlight = elements.Highlight
            
            local vec, onScreen = CurrentCamera:WorldToScreenPoint(pos)
            local distance = (pos - hrpPosition).Magnitude

            highlight.Enabled = onScreen and distance < 1000 
            
            if distance < 10000 then 
                label.Visible = true
                
                local nameToDisplay = data.isModel and data.Name or data.Name .. " Loot"

                if onScreen then
                    label.Position = UDim2.new(0, vec.X - label.Size.X.Offset / 2, 0, vec.Y)
                    label.Text = string.format("%s [~%.0fM]", nameToDisplay, distance)
                else
                    local viewPortSize = CurrentCamera.ViewportSize
                    local center = Vector2.new(viewPortSize.X / 2, viewPortSize.Y / 2)
                    local vector2 = Vector2.new(vec.X, vec.Y)
                    
                    local direction = (vector2 - center).unit
                    local radius = math.min(center.X, center.Y) * 0.95 
                    
                    local newPos = center + direction * radius
                    
                    label.Position = UDim2.new(0, newPos.X - label.Size.X.Offset / 2, 0, newPos.Y - label.Size.Y.Offset / 2)
                    label.Text = string.format("-> %s [~%.0fM]", nameToDisplay, distance)
                    
                    highlight.Enabled = false 
                end
            else
                label.Visible = false
                highlight.Enabled = false
            end
        else
            -- Tr∆∞·ªùng h·ª£p pos l√† nil, ch√∫ng ta v·∫´n c·∫ßn ƒë·∫£m b·∫£o ·∫©n Label v√† Highlight
             if espElements[itemKey] then
                pcall(function() espElements[itemKey].Label.Visible = false end)
                pcall(function() espElements[itemKey].Highlight.Enabled = false end)
            end
        end
    end
    
    -- D·ªçn d·∫πp c√°c ph·∫ßn t·ª≠ kh√¥ng c√≤n trong danh s√°ch m·ª•c ti√™u
    for itemKey, elements in pairs(espElements) do
        if not currentTargets[itemKey] and elements.Label.Visible then
            pcall(function() elements.Label.Visible = false end)
            pcall(function() 
                if elements.Highlight.Parent == itemKey then elements.Highlight.Enabled = false end 
            end)
        end
    end
end

local function isAnyEspActive()
    for _, config in pairs(espSettings) do
        if config.Enabled then return true end
    end
    return false
end

local function startEspLoop()
    if espRenderStep then return end
    createEspGui()
    espRenderStep = RunService.RenderStepped:Connect(updateUniversalESP)
end

local function stopEspLoop()
    if espRenderStep and not isAnyEspActive() then
        espRenderStep:Disconnect()
        espRenderStep = nil
        if espGui then 
            espGui:Destroy() 
            espGui = nil 
            espElements = {}
        end
    end
end

-- H√†m Callback chung cho ESP
local function toggleEspSetting(settingName, Value)
    espSettings[settingName].Enabled = Value
    if Value then
        startEspLoop()
    else
        for itemKey, elements in pairs(espElements) do
            local item = itemKey
            if item and (
                (settingName == "Player" and item:IsA("Model") and item:FindFirstChildOfClass("Humanoid")) or 
                (settingName == "Chain" and item.Name == "CHAIN") or
                (settingName == "Scrap" and item.Name == "Scrap") or
                (settingName == "Arctic" and item.Name == "Arctic")
            ) then
                pcall(function() elements.Label.Visible = false end)
                pcall(function() elements.Highlight.Enabled = false end)
            end
        end
        stopEspLoop()
    end
end

--- H√ÄM: LIGHTING & FULLBRIGHT ---

local originalLightingProperties = {}
local originalEffectsState = {}
local isFullbrightActive = false

local function saveOriginalSettings()
    originalLightingProperties.Ambient = Lighting.Ambient
    originalLightingProperties.OutdoorAmbient = Lighting.OutdoorAmbient
    originalLightingProperties.Brightness = Lighting.Brightness
    originalLightingProperties.TimeOfDay = Lighting.TimeOfDay
    originalLightingProperties.FogEnd = Lighting.FogEnd
    originalLightingProperties.GlobalShadows = Lighting.GlobalShadows
    
    for _, child in ipairs(Lighting:GetChildren()) do
        if child:IsA("PostEffect") then 
            originalEffectsState[child] = child.Enabled
        end
    end
end

local function restoreOriginalSettings()
    for property, value in pairs(originalLightingProperties) do
        Lighting[property] = value
    end
    for effect, isEnabled in pairs(originalEffectsState) do
        if pcall(function() return effect.Parent end) then 
            effect.Enabled = isEnabled
        end
    end
end

saveOriginalSettings()

local function toggleFullbright(Value)
    isFullbrightActive = Value
    
    if Value then
        for _, effect in ipairs(Lighting:GetChildren()) do 
            if effect:IsA("BloomEffect") or effect:IsA("BlurEffect") or effect:IsA("ColorCorrectionEffect") or effect:IsA("SunRaysEffect") or effect:IsA("DepthOfFieldEffect") then 
                effect.Enabled = false 
            end 
        end
        Lighting.Ambient = Color3.new(1, 1, 1)
        Lighting.OutdoorAmbient = Color3.new(1, 1, 1)
        Lighting.Brightness = 5
        Lighting.TimeOfDay = "12:00:00"
        Lighting.GlobalShadows = false
        Lighting.FogEnd = 100000 
    else
        restoreOriginalSettings()
    end
end

local function setNoFog()
    Lighting.FogEnd = 100000 
    Lighting.FogStart = 0
    Fluent:Notify({ Title = "Th√†nh c√¥ng!", Content = "ƒê√£ lo·∫°i b·ªè s∆∞∆°ng m√π (NoFog).", Duration = 3 })
end

--- H√†m Notifications ---

local notificationSettings = { power = true, roundTime = true, chain = true, artifact = true, airdrop = true, playSound = true }

local function playNotificationSound()
    if not notificationSettings.playSound then return end
    pcall(function()
        local sound = Instance.new("Sound")
        sound.SoundId = "rbxassetid://15641323951"
        sound.Volume = 8 
        sound.Parent = Workspace
        sound:Play()
        Debris:AddItem(sound, 3)
    end)
end

local function setupNotificationSystem()
    local valuesFolder = Workspace.GameStuff and Workspace.GameStuff:WaitForChild("Values", 5)
    local aiFolder = Workspace:FindFirstChild("Misc") and Workspace.Misc:WaitForChild("AI", 5)
    local artifactsFolder = Workspace:FindFirstChild("Misc") and Workspace.Misc:FindFirstChild("Zones") and Workspace.Misc.Zones:FindFirstChild("LootingItems") and Workspace.Misc.Zones.LootingItems:WaitForChild("Artifacts", 5)
    local airDropsFolder = Workspace.GameStuff and Workspace.GameStuff:WaitForChild("GameSections") and Workspace.GameStuff.GameSections:WaitForChild("AirDrops", 5)

    if not valuesFolder or not aiFolder then return end

    local function createThresholdNotifier(config)
        local hasBeenNotified = false
        valuesFolder:GetAttributeChangedSignal(config.Attribute):Connect(function()
            if not notificationSettings[config.SettingName] then return end
            local value = valuesFolder:GetAttribute(config.Attribute)
            
            if type(value) == "number" and value <= config.Threshold and not hasBeenNotified then
                hasBeenNotified = true
                playNotificationSound()
                Fluent:Notify({ Title = config.Title, Content = config.Content, Duration = 8 })
            elseif type(value) == "number" and value > config.Threshold and hasBeenNotified then
                hasBeenNotified = false
            end
        end)
    end

    createThresholdNotifier({ Attribute = "Power", SettingName = "power", Threshold = 30, Title = "Low Power!", Content = "30% power remaining." })
    createThresholdNotifier({ Attribute = "RoundTime", SettingName = "roundTime", Threshold = 30, Title = "Round Ending!", Content = "30 seconds remaining!" })

    task.spawn(function()
        local isChainActive = false
        while task.wait(3) do
            if notificationSettings.chain then
                local chain = aiFolder:FindFirstChild("CHAIN")
                local alive = chain and chain:FindFirstChild("Humanoid") and chain.Humanoid.Health > 0
                
                if alive and not isChainActive then
                    isChainActive = true
                    playNotificationSound()
                    Fluent:Notify({ Title = "‚ÄºÔ∏è CHAIN HAS SPAAWN ‚ÄºÔ∏è", Content = "K·∫ª th√π ch√≠nh ƒë√£ xu·∫•t hi·ªán tr√™n b·∫£n ƒë·ªì.", Duration = 10 })
                elseif not alive and isChainActive then
                    isChainActive = false
                    playNotificationSound()
                    Fluent:Notify({ Title = "‚úÖ CHAIN DEFEATED ‚úÖ", Content = "Chain ƒë√£ b·ªã ƒë√°nh b·∫°i.", Duration = 10 })
                end
            end
        end
    end)

    if artifactsFolder then
        artifactsFolder.ChildAdded:Connect(function(child)
            if notificationSettings.artifact and child:IsA("Model") then
                playNotificationSound()
                Fluent:Notify({ Title = "Artifact Spawned!", Content = "M·ªôt Artifact m·ªõi ƒë√£ xu·∫•t hi·ªán.", Duration = 7 })
            end
        end)
    end

    if airDropsFolder then
        airDropsFolder.ChildAdded:Connect(function(child)
            if notificationSettings.airdrop and child:IsA("Model") then
                playNotificationSound()
                Fluent:Notify({ Title = "Airdrop Detected!", Content = "M·ªôt Airdrop ƒë√£ xu·∫•t hi·ªán.", Duration = 8 })
            end
        end)
    end
end

task.spawn(setupNotificationSystem)


-- =========================================================================
-- UI SETUP (KH·ªûI T·∫†O GIAO DI·ªÜN FLUENT)
-- =========================================================================

local Window = Fluent:CreateWindow({
    Title = "üí¢ Purium üí¢ | Chain | (Beta) 1.71",
    SubTitle = "by Purium | Full Feature Set",
    TabWidth = 160,
    Size = UDim2.fromOffset(515, 370),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.RightControl,

    UserInfo = true,
    UserInfoTop = false,
    UserInfoTitle = game:GetService("Players").LocalPlayer.DisplayName,
    UserInfoSubtitle = "Premuim User",
    UserInfoSubtitleColor = Color3.fromRGB(71, 123, 255)
})

local Tabs = {
    Main = Window:AddTab({ Title = "Utility / Misc", Icon = "home" }),
    Character = Window:AddTab({ Title = "Character Exploits", Icon = "user" }),
    Movement = Window:AddTab({ Title = "Movement / Teleport", Icon = "map" }),
    Visuals = Window:AddTab({ Title = "Visuals / ESP", Icon = "eye" }),
    Tools = Window:AddTab({ Title = "Unlock / GUI Tools", Icon = "box" }),
    Lighting = Window:AddTab({ Title = "Lighting Control", Icon = "sun" }),
    Notify = Window:AddTab({ Title = "Notifications", Icon = "bell" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}


-- =========================================================================
-- SETUP MINIMIZE BUTTON 
-- =========================================================================
local ExistingUI = CoreGui:FindFirstChild("PuriumHubMinimizeUI")
if ExistingUI then ExistingUI:Destroy() end

local DragUI = Instance.new("ScreenGui")
DragUI.Name = "PuriumHubMinimizeUI"
DragUI.ResetOnSpawn = false
DragUI.Parent = CoreGui

local Button = Instance.new("ImageButton")
Button.Parent = DragUI
Button.Size = UDim2.new(0, 50, 0, 50)
Button.Position = UDim2.new(0, 10, 1, -85)
Button.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Button.BackgroundTransparency = 0.3
Button.BorderSizePixel = 0
Button.Image = "rbxassetid://109647470925993" 
Button.ScaleType = Enum.ScaleType.Fit
Button.Active = true
Button.ZIndex = 1000

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(1, 0)
UICorner.Parent = Button

local isDragging = false
local dragStart, startPos

local function ToggleUI()
    if Window then Window:Minimize() end
end

Button.MouseButton1Click:Connect(function()
    if isDragging then 
        isDragging = false 
        return 
    end
    ToggleUI()
end)

Button.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        isDragging = false
        dragStart = input.Position
        startPos = Button.Position
    end
end)

Button.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        if dragStart then
            local delta = (input.Position - dragStart).Magnitude
            if delta > 10 then 
                isDragging = true
                Button.Position = UDim2.new(
                    startPos.X.Scale, 
                    startPos.X.Offset + (input.Position.X - dragStart.X), 
                    startPos.Y.Scale, 
                    startPos.Y.Offset + (input.Position.Y - dragStart.Y)
                )
            end
        end
    end
end)

Button.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragStart = nil
        startPos = nil
    end
end)


-- =========================================================================
-- TAB: UTILITY / MISC
-- =========================================================================

Tabs.Main:AddButton({
    Title = "Load Infinite Yield (Admin Commands)",
    Callback = function() loadstring(game:HttpGet('https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source'))() end
})

Tabs.Main:AddButton({
    Title = "Load DEX Explorer (Game Structure)",
    Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/infyiff/backup/main/dex.lua"))() end
})

Tabs.Main:AddButton({
    Title = "Remove Adonis Anti-Cheat",
    Description = "C·∫ßn thi·∫øt cho Inf Dodge",
    Callback = function() 
        local adonis = "https://raw.githubusercontent.com/Pixeluted/adoniscries/refs/heads/main/Source.lua"
        loadstring(game:HttpGet(adonis))()
    end
})

Tabs.Main:AddToggle("BarrierDestroyer", {
    Title = "Destroy Invisible Barriers",
    Description = "Ph√° h·ªßy c√°c v·∫≠t c·∫£n v√¥ h√¨nh (Transparency = 1, CanCollide = true)",
    Default = false,
    Callback = toggleBarrierDestroyer
})

Tabs.Main:AddButton({
    Title = "Third Person Max Zoom",
    Description = "Chuy·ªÉn sang g√≥c nh√¨n th·ª© ba c·ªï ƒëi·ªÉn",
    Callback = ThirdPerson
})

Tabs.Main:AddButton({
    Title = "Remove Mask on Head",
    Description = "X√≥a m·∫∑t n·∫°/t√∫i tr√™n ƒë·∫ßu nh√¢n v·∫≠t (n·∫øu c√≥)",
    Callback = removeMask
})

Tabs.Main:AddButton({
    Title = "Destroy Current GUI",
    Description = "ƒê√≥ng v√† x√≥a to√†n b·ªô giao di·ªán Script",
    Callback = function() 
        Window:Destroy()
        if DragUI then DragUI:Destroy() end
        if espRenderStep then espRenderStep:Disconnect() end 
        if espGui then espGui:Destroy() end
        NOFLY()
        toggleNoclip(false)
        toggleFullbright(false) 
        toggleJumpUnlock(false)
        toggleAntiAFK(false)
        Fluent:Notify({ Title = "Th√†nh c√¥ng!", Content = "ƒê√£ d·ªçn d·∫πp v√† x√≥a script.", Duration = 3 })
    end,
})

-- =========================================================================
-- TAB: CHARACTER EXPLOITS
-- =========================================================================

Tabs.Character:AddToggle("InfStamina", {
    Title = "Infinite Stamina",
    Description = "Stamina lu√¥n ƒë·∫ßy (di chuy·ªÉn)",
    Default = false,
    Callback = toggleInfStamina
})

Tabs.Character:AddToggle("InfCombatStamina", {
    Title = "Infinite Combat Stamina",
    Description = "Stamina lu√¥n ƒë·∫ßy (t·∫•n c√¥ng)",
    Default = false,
    Callback = toggleInfCombatStamina
})

Tabs.Character:AddToggle("InfGas", {
    Title = "Infinite XSaw Gas",
    Description = "B·∫≠t c∆∞a XSaw kh√¥ng gi·ªõi h·∫°n",
    Default = false,
    Callback = toggleInfGas
})

Tabs.Character:AddToggle("AutoWinClash", {
    Title = "Auto Win XSaw Clash",
    Description = "T·ª± ƒë·ªông th·∫Øng khi giao chi·∫øn b·∫±ng c∆∞a",
    Default = false,
    Callback = toggleAutoWinClash
})

Tabs.Character:AddToggle("InfDodge", {
    Title = "Infinite Dodge (ƒê√É FIX L·ªñI)",
    Description = "N√© tr√°nh kh√¥ng gi·ªõi h·∫°n (C·∫ßn g·ª° Anti-Cheat tr∆∞·ªõc)",
    Default = false,
    Callback = function(Value)
        if Value then
            enableInfDodge()
            Fluent:Notify({ Title = "L∆ØU √ù", Content = "Ch·∫Øc ch·∫Øn ƒë√£ g·ª° Anti-Cheat tr∆∞·ªõc khi b·∫≠t!", Duration = 5 })
        else
            if infDodgeConnection and infDodgeConnection.Disconnect then infDodgeConnection:Disconnect() end
        end
    end
})

Tabs.Character:AddToggle("CancelRecoil", {
    Title = "Cancel Recoil (X√≥a ƒë·ªô gi·∫≠t s√∫ng)",
    Description = "Lo·∫°i b·ªè ƒë·ªô l·ªách camera do ƒë·ªô gi·∫≠t t·∫°o ra",
    Default = false,
    Callback = toggleCancelRecoil
})

Tabs.Character:AddToggle("Aimbot", {
    Title = "Aimbot (Gi·ªØ chu·ªôt ph·∫£i)",
    Description = "Camera kh√≥a v√†o m·ª•c ti√™u (Chain Boss)",
    Default = false,
    Callback = toggleAimbot
})

Tabs.Character:AddToggle("JumpUnlocker", {
    Title = "Unlock Jump (B·ªè kh√≥a nh·∫£y)",
    Description = "Gi√∫p b·∫°n lu√¥n c√≥ th·ªÉ nh·∫£y (Humanoid.JumpPower)",
    Default = false,
    Callback = toggleJumpUnlock
})

Tabs.Character:AddToggle("AntiAFK", {
    Title = "Anti-AFK (Di chuy·ªÉn nh·∫π nh√†ng)",
    Description = "M√¥ ph·ªèng b·∫•m W/S ƒë·ªÉ ch·ªëng b·ªã kick AFK",
    Default = false,
    Callback = toggleAntiAFK
})

Tabs.Character:AddSlider("WalkSpeed", {
    Title = "T·ªëc ƒë·ªô di chuy·ªÉn (Walk Speed)",
    Default = defaultWalkSpeed,
    Min = defaultWalkSpeed,
    Max = 200,
    Rounding = 1,
    Callback = function(Value)
        targetWalkSpeed = Value
    end
})

RunService.Heartbeat:Connect(function()
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        if LocalPlayer.Character.Humanoid.WalkSpeed ~= targetWalkSpeed then
            LocalPlayer.Character.Humanoid.WalkSpeed = targetWalkSpeed
        end
    end
end)

-- =========================================================================
-- TAB: MOVEMENT / TELEPORT
-- =========================================================================

Tabs.Movement:AddToggle("Fly", {
    Title = "Fly Mode (Ph√≠m V ƒë·ªÉ d·ª´ng)",
    Default = false,
    Callback = function(Value)
        if Value then sFLY(100) else NOFLY() end
    end
})

Tabs.Movement:AddToggle("Noclip", {
    Title = "Noclip (Xuy√™n t∆∞·ªùng)",
    Default = false,
    Callback = toggleNoclip
})

Tabs.Movement:AddToggle("ClickTeleport", {
    Title = "Click Teleport (Gi·ªØ Ctrl + Click)",
    Description = "D·ªãch chuy·ªÉn t·ªõi v·ªã tr√≠ chu·ªôt",
    Default = false,
    Callback = toggleClickTeleport
})

Tabs.Movement:AddButton({
    Title = "Server Hop (Chuy·ªÉn Server)",
    Description = "Chuy·ªÉn sang m·ªôt server ng·∫´u nhi√™n kh√°c",
    Callback = simpleServerHop
})

local function bringPlr(cframe) 
    local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild('HumanoidRootPart')
    if hrp then hrp.CFrame = cframe end
end

local function getChainBossCFrame()
    local aiFolder = Workspace:FindFirstChild("Misc") and Workspace.Misc:FindFirstChild("AI")
    if not aiFolder then return nil end
    local chain = aiFolder:FindFirstChild("CHAIN")
    if chain and chain:IsA("Model") and chain:FindFirstChild("HumanoidRootPart") then
        return chain:GetPivot()
    end
    return nil
end

local TELEPORT_LOCATIONS = {
    ["SafeHouse"] = CFrame.new(162.68, -94.26, 230.03),
    ["WorkShop Outside"] = CFrame.new(130.92, -106.07, -2.17),
    ["Shop"] = CFrame.new(-111.37, -87.20, 203.52),
    ["PowerStation"] = CFrame.new(-208.29, -110.60, -120.22),
    ["WareHouse"] = CFrame.new(314.62, -113.51, -258.48),
    ["Ritual Site"] = CFrame.new(-18.60, -107.77, -229.89),
    ["LeaderBoard"] = CFrame.new(45.65, -97.96, 25.84),
}

Tabs.Movement:AddSection("Teleports")

for name, cf in pairs(TELEPORT_LOCATIONS) do
    Tabs.Movement:AddButton({
        Title = "TP: " .. name,
        Callback = function() bringPlr(cf) end
    })
end

Tabs.Movement:AddButton({
    Title = "TP: Chain Boss",
    Callback = function()
        local cf = getChainBossCFrame()
        if cf then 
            bringPlr(cf * CFrame.new(0, 5, 0))
        else 
            Fluent:Notify({Title="L·ªói", Content="Kh√¥ng t√¨m th·∫•y Chain Boss tr√™n b·∫£n ƒë·ªì."})
        end
    end
})

Tabs.Movement:AddButton({
    Title = "TP: Airdrop Location",
    Callback = findAndTeleportToAirdrop
})

-- =========================================================================
-- TAB: VISUALS / ESP (S·ª¨ D·ª§NG H·ªÜ TH·ªêNG UNIFIED ESP M·ªöI)
-- =========================================================================

Tabs.Visuals:AddToggle("PlayerChams", {
    Title = "Player ESP (Chams + Label)",
    Description = "Highlight v√† hi·ªÉn th·ªã Label/Kho·∫£ng c√°ch Ng∆∞·ªùi ch∆°i",
    Default = false,
    Callback = function(Value) toggleEspSetting("Player", Value) end
})

Tabs.Visuals:AddToggle("ChainESP", {
    Title = "Chain Boss ESP (Chams + Label)",
    Description = "Highlight v√† hi·ªÉn th·ªã Label/Kho·∫£ng c√°ch Chain Boss",
    Default = false,
    Callback = function(Value) toggleEspSetting("Chain", Value) end
})

Tabs.Visuals:AddToggle("ScrapESP", {
    Title = "Scrap ESP (Label + Chams)",
    Description = "Hi·ªÉn th·ªã Label/Highlight cho Scrap",
    Default = false,
    Callback = function(Value) toggleEspSetting("Scrap", Value) end
})

Tabs.Visuals:AddToggle("ArcticESP", {
    Title = "Arctic ESP (Label + Chams)",
    Description = "Hi·ªÉn th·ªã Label/Highlight cho Arctic",
    Default = false,
    Callback = function(Value) toggleEspSetting("Arctic", Value) end
})

Tabs.Visuals:AddToggle("ChainInfoGUI", {
    Title = "Chain Info GUI (Hi·ªÉn th·ªã th·ªùi gian/Power)",
    Description = "Hi·ªÉn th·ªã th√¥ng tin tr·∫≠n ƒë·∫•u tr√™n m√†n h√¨nh",
    Default = false,
    Callback = toggleInfoGUI
})

Tabs.Visuals:AddToggle("HideScreenEffects", {
    Title = "Annoying Chain Screen effect (X√≥a hi·ªáu ·ª©ng Chain)",
    Description = "X√≥a hi·ªáu ·ª©ng m√†n h√¨nh kh√≥ ch·ªãu khi Chain xu·∫•t hi·ªán",
    Default = false,
    Callback = toggleHideScreenEffects
})

-- =========================================================================
-- TAB: UNLOCK / GUI TOOLS 
-- =========================================================================

Tabs.Tools:AddButton({
    Title = "Unlock CombatKnife",
    Description = "M·ªü kh√≥a b·∫£n thi·∫øt k·∫ø: CombatKnife",
    Callback = function() unlockBlueprint("CombatKnife") end
})

Tabs.Tools:AddButton({
    Title = "Unlock DoubleBarrel",
    Description = "M·ªü kh√≥a b·∫£n thi·∫øt k·∫ø: DoubleBarrel",
    Callback = function() unlockBlueprint("DoubleBarrel") end
})

Tabs.Tools:AddButton({
    Title = "Unlock M1911",
    Description = "M·ªü kh√≥a b·∫£n thi·∫øt k·∫ø: M1911",
    Callback = function() unlockBlueprint("M1911") end
})

Tabs.Tools:AddSection("Toggle Game GUIs")

Tabs.Tools:AddToggle("WorkbenchGui", {
    Title = "Toggle Workbench Gui",
    Description = "Hi·ªán/·∫®n giao di·ªán Ch·∫ø t·∫°o",
    Default = false,
    Callback = toggleWorkbenchGui
})

Tabs.Tools:AddToggle("DeconstructorGui", {
    Title = "Toggle Deconstructor Gui",
    Description = "Hi·ªán/·∫®n giao di·ªán Th√°o d·ª°",
    Default = false,
    Callback = toggleDeconstructorGui
})

Tabs.Tools:AddToggle("ShopGui", {
    Title = "Toggle Shop Gui",
    Description = "Hi·ªán/·∫®n giao di·ªán C·ª≠a h√†ng",
    Default = false,
    Callback = toggleShopGui
})

-- =========================================================================
-- TAB: LIGHTING CONTROL
-- =========================================================================

Tabs.Lighting:AddToggle("Fullbright", {
    Title = "Fullbright (S√°ng tuy·ªát ƒë·ªëi)",
    Description = "√Ånh s√°ng t·ªëi ƒëa, x√≥a b√≥ng, lo·∫°i b·ªè hi·ªáu ·ª©ng s∆∞∆°ng m√π",
    Default = false,
    Callback = toggleFullbright
})

Tabs.Lighting:AddButton({
    Title = "NoFog (Lo·∫°i b·ªè s∆∞∆°ng m√π)",
    Description = "Thi·∫øt l·∫≠p l·∫°i t·∫ßm nh√¨n (FogEnd)",
    Callback = setNoFog
})

Tabs.Lighting:AddButton({
    Title = "Restore Default Lighting",
    Description = "Kh√¥i ph·ª•c c√†i ƒë·∫∑t √°nh s√°ng g·ªëc c·ªßa game",
    Callback = function()
        toggleFullbright(false) 
        restoreOriginalSettings()
        Fluent:Notify({ Title = "Th√†nh c√¥ng!", Content = "ƒê√£ kh√¥i ph·ª•c c√†i ƒë·∫∑t √°nh s√°ng g·ªëc.", Duration = 3 })
    end
})


-- =========================================================================
-- TAB: NOTIFICATIONS
-- =========================================================================
Tabs.Notify:AddToggle("NotifyPower", { Title = "Low Power (30%)", Default = true, Callback = function(v) notificationSettings.power = v end })
Tabs.Notify:AddToggle("NotifyRound", { Title = "Round End (30s)", Default = true, Callback = function(v) notificationSettings.roundTime = v end })
Tabs.Notify:AddToggle("NotifyChain", { Title = "Chain Spawn/Defeat", Default = true, Callback = function(v) notificationSettings.chain = v end })
Tabs.Notify:AddToggle("NotifyArtifact", { Title = "Artifact Spawn", Default = true, Callback = function(v) notificationSettings.artifact = v end })
Tabs.Notify:AddToggle("NotifyAirdrop", { Title = "Airdrop Spawn", Default = true, Callback = function(v) notificationSettings.airdrop = v end })
Tabs.Notify:AddToggle("NotifySound", { Title = "Play Sounds for Notifications", Default = true, Callback = function(v) notificationSettings.playSound = v end })


-- =========================================================================
-- FINAL INIT (QU·∫¢N L√ù L∆ØU TR·ªÆ V√Ä C·∫§U H√åNG)
-- =========================================================================

SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
InterfaceManager:SetFolder("Purium HUB")
SaveManager:SetFolder("Purium HUB/Chain")
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)
Window:SelectTab(1)
Fluent:Notify({ 
Title = "Purium HUB",
Content = "Chain script loaded successfully!",
Duration = 5 })
SaveManager:LoadAutoloadConfig()
